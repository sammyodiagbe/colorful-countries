import Head from "next/head";
import styles from "../styles/Home.module.css";
import { FaSearch } from "react-icons/fa";
import { useState, useRef, useEffect } from "react";
import axios from "axios";
import Country from "../layouts/country";
import Layout from "../layouts/Layout";
import { FaChevronDown } from "react-icons/fa";

export default function Home({ country_data }) {
  const [filterValue, setFilterValue] = useState("");
  const [showMenu, setShowMenu] = useState(false);
  const [countries, setCountries] = useState([]);
  const [searchQuery, setSearchQuery] = useState("");
  const [fetchingData, isFetchingData] = useState(false);
  useEffect(() => {
    setCountries(country_data);
  }, []);

  const renderCountries = countries.map((country, index) => {
    return <Country key={index} data={{ ...country }} />;
  });

  const inputRef = useRef(null);
  const filterCountries = async (e) => {
    e.preventDefault();
    try {
      if (fetchingData) return;
      isFetchingData(true);
      const { filter } = e.target.dataset;
      const response = await axios.get(
        filter === "All"
          ? `https://restcountries.eu/rest/v2/all`
          : `https://restcountries.eu/rest/v2/region/${filter}`
      );
      setCountries(response.data);
      isFetchingData(false);
      inputRef.current.setAttribute("placeholder", filter);
      setShowMenu(false);
    } catch (err) {
      isFetchingData(false);
    }
  };

  const findCountry = async (event) => {
    event.preventDefault();
    if (fetchingData) return;
    isFetchingData(true);
    if (searchQuery.trim() === "") return;
    try {
      const response = await axios.get(
        `https://restcountries.eu/rest/v2/name/${encodeURIComponent(
          searchQuery
        )}`
      );
      const data = response.data;
      setCountries(data);
      isFetchingData(false);
    } catch (err) {
      isFetchingData(false);
    }
  };

  return (
    <Layout>
      <div className={styles.container}>
        <Head>
          <title>Colorful Countries</title>
          <meta name="description" content="Generated by create next app" />
          <meta name="author" content="Odiagbe Samson Osaro" />
          <link rel="icon" href="/favicon.ico" />
        </Head>
        <div className={styles.inputAndFilterContainer}>
          <div className={styles.inputContainer}>
            <FaSearch className={styles.buttonIcon} />
            <form onSubmit={findCountry}>
              <input
                type="text"
                placeholder="Search for a country"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
              />
            </form>
          </div>

          {/* build custom select */}
          <div className={styles.filter}>
            <div className={styles.filterContainer}>
              <div className={styles.valueContainer}>
                <input
                  type="text"
                  placeholder="Filter by Region"
                  className={styles.value}
                  readOnly
                  onFocus={() => setShowMenu(true)}
                  onBlur={() => setShowMenu(false)}
                  ref={inputRef}
                />
                <FaChevronDown className={styles.icon} />
              </div>
              {showMenu && (
                <div className={styles.options}>
                  <button
                    className={styles.option}
                    onClick={filterCountries}
                    data-filter="All"
                  >
                    All
                  </button>
                  <button
                    className={styles.option}
                    onClick={filterCountries}
                    data-filter="Europe"
                  >
                    Europe
                  </button>
                  <button
                    className={styles.option}
                    onClick={filterCountries}
                    data-filter="Africa"
                  >
                    Africa
                  </button>
                  <button
                    className={styles.option}
                    onClick={filterCountries}
                    data-filter="Americas"
                  >
                    Americas
                  </button>
                  <button
                    className={styles.option}
                    onClick={filterCountries}
                    data-filter="Asia"
                  >
                    Asia
                  </button>
                  <button
                    className={styles.option}
                    onClick={filterCountries}
                    data-filter="Oceania"
                  >
                    Oceania
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
        <div className={styles.countriesContainer}>
          {fetchingData ? (
            <div className={styles.spinner}>
              <span />
              <span />
              <span></span>
            </div>
          ) : (
            renderCountries
          )}
        </div>
      </div>
    </Layout>
  );
}

export async function getServerSideProps(context) {
  let country_data;
  try {
    let res = await axios.get("https://restcountries.eu/rest/v2/region/europe");
    country_data = res.data;
  } catch (err) {
    console.log("something broke, ", err);
  }

  return {
    props: { country_data },
  };
}
